#!/usr/bin/env ruby

class MetasploitModule < Msf::Auxiliary

  Rank = NormalRanking
  include Msf::Exploit::Remote::Tcp
  include Msf::Auxiliary::Scanner

    def initialize(info = {})
        super(update_info(info,
        'Name'     => 'MS17-010 (EternalBlue) vulnerability checker',
        'Description' => %q{
            This module performs vulnerability assessment for MS17-010 (EternalBlue)
            exploit on target Windows systems using SMB protocol analysis.
        },
        'Author'   => [ 'Anomaliszt' ],
        'License'  => MSF_LICENSE))

        register_options(
            [
                Opt::RHOST(),
                OptPort.new('RPORT', [ true, 'Target SMB port number', 445 ])
            ]
        )
    end
      
    def run_host(ip)
        print_status("Scanning #{ip} for EternalBlue vulnerability (MS17-010)")

        sock = connect
        smb_request = "\x00\x00\x00\x90" +
                  "\xffSMB@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" +
                  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" +
                  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" +
                  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" +
                  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" +
                  "\x00\x00"
        sock.put(smb_request)
        response = sock.get_once(-1, 5)

        if response && response.include?("Public")
            print_good("#{ip} - VULNERABLE to MS17-010 (EternalBlue)")
        else
            print_error("#{ip} - Not vulnerable to MS17-010")
        end

        disconnect
        rescue ::Interrupt
            raise
        rescue ::Rex::ConnectionError
            print_error("#{ip} - Unable to establish connection")
    end
end
